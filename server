import socket
import hashlib

# Modular exponentiation
def mod_exp(base, exponent, mod):
    result = 1
    base = base % mod
    while exponent > 0:
        if exponent % 2 == 1:
            result = (result * base) % mod
        exponent //= 2
        base = (base * base) % mod
    return result

# Receive p and q from user
p = int(input("Enter prime p: "))
q = int(input("Enter prime q: "))

n = p * q
phi = (p - 1) * (q - 1)

e = 7  # Fixed small public exponent for simplicity

# Find d
for i in range(1, phi):
    if (i * e) % phi == 1:
        d = i
        break

print("Private key:", (d, n))

def decrypt_string(cipher_list):
    message = ""
    for num in cipher_list:
        plain_ascii = mod_exp(num, d, n)
        message += chr(plain_ascii)
    return message

# Socket
s = socket.socket()
s.bind(("localhost", 12345))
s.listen(1)
print("Server waiting...")

conn, addr = s.accept()

data = conn.recv(4096).decode()
cipher_part, recv_hash = data.split("|")

cipher_list = list(map(int, cipher_part.split(",")))

message = decrypt_string(cipher_list)
print("Decrypted Message:", message)

# Hash verification
calc_hash = hashlib.sha256(message.encode()).hexdigest()

print("Received Hash:", recv_hash)
print("Calculated Hash:", calc_hash)

if calc_hash == recv_hash:
    print("Integrity Verified ✔")
else:
    print("Message Tampered ❌")

conn.close()
