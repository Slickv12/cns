import socket
import hashlib

def mod_exp(base, exponent, mod):
    result = 1
    base %= mod
    while exponent > 0:
        if exponent % 2 == 1:
            result = (result * base) % mod
        exponent //= 2
        base = (base * base) % mod
    return result

# User input primes
p = int(input("Enter prime p: "))
q = int(input("Enter prime q: "))

n = p * q
phi = (p - 1) * (q - 1)
e = 7

# Calculate private key d
for i in range(1, phi):
    if (i * e) % phi == 1:
        d = i
        break

print("Private Key:", (d, n))

def decrypt_string(cipher_list):
    message = ""
    for num in cipher_list:
        message += chr(mod_exp(num, d, n))
    return message

# Socket setup
s = socket.socket()
s.bind(("localhost", 12345))
s.listen(1)
print("Server waiting...")

conn, addr = s.accept()

data = conn.recv(4096).decode()
cipher_part, recv_hash = data.split("|")

cipher_list = list(map(int, cipher_part.split(",")))

message = decrypt_string(cipher_list)
print("Decrypted Message:", message)

# MD5 Hash verification
calc_hash = hashlib.md5(message.encode()).hexdigest()

print("Received MD5:", recv_hash)
print("Calculated MD5:", calc_hash)

if calc_hash == recv_hash:
    print("Integrity Verified ✔")
else:
    print("Message Tampered ❌")

conn.close()
